# VDPT MVP

This repository hosts a minimal FastAPI application that exposes a todo-focused API together with automated tests and CI configuration.

## Features

- **Health endpoint** to verify the service availability.
- **Todo endpoints** for listing, creating, and completing items stored in memory.
- **Pytest suite** that exercises the core API behaviour using FastAPI's `TestClient`.
- **GitHub Actions workflow** that installs dependencies and runs the tests on every push and pull request targeting `main`.

## Getting started

1. Create and activate a virtual environment:
   ```bash
   python -m venv .venv
   source .venv/bin/activate
   ```
2. Install dependencies:
   ```bash
   python -m pip install --upgrade pip
   python -m pip install -r backend/requirements.txt pytest
   ```

3. (Optional but recommended) Install the git hooks:
   ```bash
   python -m pip install pre-commit
   pre-commit install
   ```

## Running the API locally

Use the helper script to start a local development server:

```bash
./dev-run.sh
```

The server listens on [http://localhost:8000](http://localhost:8000). The automatically generated OpenAPI docs are available at `/docs`.

## Running tests

Execute the test suite with:

```bash
pytest
```

## Code style and linting

This repository uses [pre-commit](https://pre-commit.com/) to enforce formatting with Black and
linting with Ruff using the configuration defined in `pyproject.toml`.

Run the hooks across the repository with:

```bash
pre-commit run --all-files
```


## Providers

VDPT can call DashScope's Qwen models for both text and vision operations. Configure the provider with the following
environment variables:

```bash
export DASHSCOPE_API_KEY="your_dashscope_key_here"
# optional: explicitly choose the provider (auto-detects otherwise)
export VDPT_PROVIDER=qwen
# optional: return deterministic mock responses instead of calling DashScope
export VDPT_MOCK=1
```

If `VDPT_PROVIDER` is not set, the backend automatically selects the Qwen provider whenever a `DASHSCOPE_API_KEY` is
present, otherwise it falls back to the mock provider. Setting `VDPT_PROVIDER` overrides this auto-detection.

When `VDPT_MOCK` is enabled, both chat and caption requests return short deterministic placeholders so you can preview
flows without network access. Unsetting `DASHSCOPE_API_KEY` while keeping the Qwen provider active raises a clear error
at runtime to highlight the missing configuration.

## Run the UI

```bash
python -m pip install -r ui/requirements.txt
streamlit run ui/streamlit_app.py
```

## One-minute demo

```bash
export DASHSCOPE_API_KEY="..."
python -m uvicorn backend.app.main:app --reload --port 8000
streamlit run ui/streamlit_app.py
```

With the backend and Streamlit UI running:

1. Upload `data/sample_news.csv` (or use the bundled sample in the sidebar).
2. Click **Load sample plan** to pull in `samples/plan_news_summarize.json`.
3. Hit **Preview** to generate summarizations for the sampled rows.
4. Hit **Execute** to process the full dataset and note the artifact directory path that appears.

## Troubleshooting

- Set `VDPT_MOCK=1` to exercise preview flows without making external API calls.

## Project layout

```
backend/           # FastAPI application and domain services
backend/requirements.txt  # Runtime dependencies for the API
.github/workflows/ # GitHub Actions workflow configuration
tests/             # Pytest-based automated tests
```

## Additional notes

- The API stores data in memory to keep the MVP lightweight. Persistence can be added later.
- See [`SANITY.md`](SANITY.md) for manual verification steps.
- See [`SANITY_IMAGE.md`](SANITY_IMAGE.md) for a full image workflow walkthrough.

## Real-ish Preview Examples

```bash
# simple bounding box preview (image asset will be auto-generated by the tests if missing)
curl -s -X POST http://127.0.0.1:8000/preview -H "Content-Type: application/json" \
  -d '{"ops":[{"kind":"segment","params":{"image_path":"tests/assets/sample.jpg","box":[32,32,96,96]}}]}'

# filter preview using CSV fixture
curl -s -X POST http://127.0.0.1:8000/preview -H "Content-Type: application/json" \
  -d '{"ops":[{"kind":"filter","params":{"csv_path":"tests/assets/sample.csv","where":"a >= 2"}}]}'
```

## VDPT MVP API
```bash
# health
curl -s http://127.0.0.1:8000/health

# preview
curl -s -X POST http://127.0.0.1:8000/preview -H "Content-Type: application/json" \
  -d '{"ops":[{"kind":"filter","params":{"where":"a > 1"}},{"kind":"segment","params":{"box":[10,10,50,50]}}]}'

# provenance snapshot
curl -s http://127.0.0.1:8000/provenance/snapshot
```
